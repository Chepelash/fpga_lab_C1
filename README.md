Модуль packet filter
====================

Модуль предназначен для фильтрации входных пакетов по нахождению заданной строки в пакете. Строка и разрешение работы задаются по интерфейсу Avalon-MM. Входной и выходной пакетные интерфейсы - Avalon-ST sink и source.


Функционально модуль состоит из друг сотавляющих:
- модуль packet_classer;
- модуль packet_resolver.


Описание параметров
-------------------

- AMM_DWIDTH - ширина шины данных интерфейса Avalon-MM. Значение по умолчанию 32;
- AST_DWIDTH - ширина шины данных интерфейса Avalon-ST. Значение по умолчанию 64;
- REG_DEPTH - количество контрольно-статусных регистров для записи искомой подстроки. Один регистр хранит значение разрешения чтения, для корректной работы минимальное значение 4. Значение по умолчанию 4;  
- BITS_PER_SYMB - количество бит на один символ. При AMM_DWIDTH = 32 и BITS_PER_SYMB = 8 в одной посылке должно быть 4 символа. Значение по умолчанию 8;
- CHANNEL_WIDTH - ширина шины сигнала channel интерфейса Avalon-ST. Для этого модуля не имеет смысл устанавливать значение больше 1. Значение по умолчанию 1.


Алгоритм работы
---------------

1. По интерфейсу Avalon-MM записывается строка для дальнейшего поиска. Строка должна быть записана в регистры по адресам от REG_DEPTH до 1. Регистр по адресу 0 является контрольным регистром, в который записывается разрешение работы модуля. Карта регистров представлена ниже.
    
    
    Карта регистров  
    <table>
      <tr>
        <th>Адрес</th>
        <th>Назначение</th>
      </tr>  
      <tr>
        <th>0x0</th>
        <th>Контрольный регистр</th>
      </tr> 
      <tr>
        <th>0x1</th>
        <th>3-0 символы ключевой строки</th>
      </tr> 
      <tr>
        <th>0x2</th>
        <th>7-4 символы ключевой строки</th>
      </tr> 
      <tr>
        <th>0x3</th>
        <th>11-8 символы ключевой строки</th>
      </tr> 
    </table>
    
    
    Адрес 0х0   
    <table>
      <tr>
        <th>Бит</th>
        <th>Название</th>
        <th>Описание</th>
      </tr>  
      <tr>
        <th>31:1</th>
        <th>Reserved</th>
        <th>---</th>
      </tr> 
      <tr>
        <th>0</th>
        <th>Enable</th>
        <th>'1' - ON, '0' - OFF</th>
      </tr> 
    </table>
   
    
1. По интерфейсу Avalon-ST пакет данных отправляется на вход модуля. Если во входном пакете есть искомая строка, то этот пакет передается на выход модуля.


Ограничения и особенности модуля
---------------------------------


- Максимальный размер посылки - 1514 байт, минимальный - 60 байт;
- порядок искомой строки - big endian.


Описание модуля packet classer
==============================


Модуль принимает на вход пакеты по интерфейсу Avalon-ST и помечает все пакеты, в которых нашлась искомая строка, используя сигнал channel выходного интерфейса. Код пометки - 1, остальные пакеты отмечаются 0. Искомая строка записывается в контрольные регистры по интерфейсу Avalon-MM. Для разрешения работы необходимо записать 1 в регистр по адресу 0х0. Принцип работы с контрольными регистрами описан выше.


Алгоритм работы модуля packet classer
-------------------------------------


1. По интерфейсу Avalon-MM записывается строка для дальнейшего поиска. Строка должна быть записана в регистры по адресам от REG_DEPTH до 1. Регистр по адресу 0 является контрольным регистром, в который записывается разрешение работы модуля.  
1. На вход модуля приходят пакеты по интерфейсу Avalon-ST. Входная посылка задерживается на 2 такта и символы входной посылки сравниваются с символами паттерна, записанного в контрольные регистры.
1. На выход модуля приходят все входные пакеты. Пакеты, в которых обнаружилась требуемая подстрока, помечается сигналом channel = 1. Чтение сигнала channel производить при сигнале конца пакета endofpacket = 1.


Описание модуля packet resolver
===============================


Модуль принимает на вход посылки по интерфейсу Avalon-ST. Модуль имеет две фифо памяти, одна - для записи входных сигналов (startofpacket, enpofpacket, data, empty), другая - для записи статусной информации (количество пакетов в посылке, наличие сигнала channel). На выход модуля отправляются посылки, помеченные сигналом channel = 1.  
Отправка данных на выход регулируется конечным автоматом. Когда статусное фифо не пустое - это значит, что как минимум одна входная посылка принята и записана в память. Модуль читает значение в статусном фифо и определяет помечена ли эта посылка сигналом channel. Если да - посылку необходимо передать, если нет - пропустить посылку в фифо данных. Пропуск посылки осуществляется сдвигом текущего адреса чтения фифо данных на значение количества пакетов в посылке, записанное в прочитанном значении статусного фифо.  


Описание состояний конечного автомата
-------------------------------------


1. IDLE_S - модуль ожидает приема посылки. Если сигнал empty статусного фифо не пуст - перейти в состояние RD_S;
1. RD_S - чтение данных из статусного фифо. На статусное фифо отправляется сигнал чтения. Безусловный переход в состояние DCD_S;
1. DCD_S - читается значение из статусного фифо и на его основе принимается значение о передаче принятой посылки на выходной интерфейс или её пропуске.   
Если посылка была помечена сигналом channel - переход в состояние TRNSM_S; если посылка не была помечена и статусное фифо не пусто - переход в состояние RD_S; иначе (посылка не была помечена и статусное фифо пусто) - переход в состояние IDLE_S;
1. TRNSM_S - чтение данных из фифо данных и оправка на выходной интерфейс. Окончание передачи определяется чтением из фифо данных сигнала endofpacket = 1 и сочетанием управляющих сигналов valid = 1 && ready = 1. По окончании чтения принимается решение о переходе. Если сигнал empty статусного фифо не пуст - перейти в состояние RD_S; иначе - перейти в состояние IDLE_S.

